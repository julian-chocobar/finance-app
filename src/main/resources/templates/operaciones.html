<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Operaciones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/operaciones-style.css}"> 

	
</head>
<body>

<script th:src="@{/js/operaciones.js}"></script>
	
<!-- Botón para abrir la barra lateral -->
<div class="open-btn" onclick="toggleSidebar()">&#9776;</div>

<!-- Barra lateral -->
<div id="sidebar">
    <a href="javascript:void(0)" class="close-btn" onclick="toggleSidebar()">&times;</a>
    <a href="/operaciones">Operaciones</a>
    <a href="/clientes">Clientes</a>
	<a href="/referidos">Referidos</a>
</div>

        <h1>Operaciones</h1>
       
		    <!-- Botón "Nueva Operación" -->
		   <div class="btn-nueva-operacion-container">
		        <button onclick="mostrarModalOperacion('crear')">Nueva Operación</button>
		   </div>
	
<!-- Modal para crear operación -->
<div id="modal-overlay">
    <div id="modal-content">
        <button id="modal-close-btn" onclick="ocultarModal()">&times;</button>
        <form id="operacionForm" method="post" onsubmit="return procesarFormulario()">
            <!-- Contenedor del formulario con scroll -->
            <div class="form-container">
                <label>Cliente:</label>
                <input type="text" id="nombreCliente" name="nombreCliente" required>

                <label>Tipo de Operación:</label>
                <select id="tipo" name="tipo" required onchange="actualizarTipoCambio()">
                    <option value="COMPRA">Compra</option>
                    <option value="VENTA">Venta</option>
                </select>

                <label>Moneda Origen:</label>
                <select id="monedaOrigen" name="monedaOrigen" required onchange="actualizarTipoCambio()">
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="BRL">BRL</option>
                    <option value="ARS">ARS</option>
                </select>

                <label>Monto Origen:</label>
                <input type="number" id="montoOrigen" name="montoOrigen" step="0.01" required>
                
                <label>Tipo de Cambio:</label>
                <input type="number" id="valorTipoCambio" name="valorTipoCambio" step="0.0001" placeholder="Esperando...">

                <label>Moneda Conversión:</label>
                <select id="monedaConversion" name="monedaConversion" required onchange="actualizarTipoCambio()">
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="BRL">BRL</option>
                    <option value="ARS">ARS</option>
                </select>
                

                <label>Referido:</label>
                <input type="text" id="nombreReferido" name="nombreReferido">

                <label>Puntos Referido:</label>
                <input type="number" id="puntosReferido" name="puntosReferido" step="0.01">

                <label>Ganancia Referido:</label>
                <input type="number" id="gananciaReferido" name="gananciaReferido" step="0.01">

                <label>Moneda Ganancia Referido:</label>
                <select id="monedaReferido" name="monedaReferido">
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="BRL">BRL</option>
                    <option value="ARS">ARS</option>
                </select>

                <!-- Sección de Pagos Origen -->
                <h3>Pagos Origen</h3>
                <div id="pagosOrigenContainer"></div>
                <button type="button" onclick="agregarPagoOrigen()">Agregar Pago Origen</button>

                <!-- Sección de Pagos Montos -->
                <h3>Pagos Conversion</h3>
                <div id="pagosMontosContainer"></div>
                <button type="button" onclick="agregarPagoMonto()">Agregar Pago Conversion</button>
            </div>

            <!-- Botones de acción (fuera del contenedor con scroll) -->
            <div class="form-actions">
                <button type="submit">Guardar</button>
                <button type="button" onclick="ocultarModal()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

      
		<!-- Filtros en formato grid -->
		<form id="filtroForm" th:action="@{/operaciones}" method="get" class="flex gap-4">
		    <input type="date" name="fechaInicio" th:value="${fechaInicio}" placeholder="Fecha inicio">
		    <input type="date" name="fechaFin" th:value="${fechaFin}" placeholder="Fecha fin">
		    
		    <input type="text" name="montoOrigen" th:value="${montoOrigen}" placeholder="Monto Origen">
		    <select name="monedaOrigen">
		        <option value="">Moneda Origen</option>
		        <option value="USD" th:selected="${monedaOrigen == 'USD'}">USD</option>
		        <option value="EUR" th:selected="${monedaOrigen == 'EUR'}">EUR</option>
		        <option value="BRL" th:selected="${monedaOrigen == 'BRL'}">BRL</option>
		        <option value="ARS" th:selected="${monedaOrigen == 'ARS'}">ARS</option>
		    </select>

		    <input type="text" name="montoConversion" th:value="${montoConversion}" placeholder="Monto Conversión">
		    <select name="monedaConversion">
		        <option value="">Moneda Conversión</option>
		        <option value="USD" th:selected="${monedaConversion == 'USD'}">USD</option>
		        <option value="EUR" th:selected="${monedaConversion == 'EUR'}">EUR</option>
		        <option value="BRL" th:selected="${monedaConversion == 'BRL'}">BRL</option>
		        <option value="ARS" th:selected="${monedaConversion == 'ARS'}">ARS</option>
		    </select>

		    <select name="tipo">
		        <option value="">Tipo</option>
		        <option value="COMPRA" th:selected="${tipo == 'COMPRA'}">Compra</option>
		        <option value="VENTA" th:selected="${tipo == 'VENTA'}">Venta</option>
		    </select>

		    <input type="text" name="clienteNombre" th:value="${clienteNombre}" placeholder="Nombre Cliente">

		    <button type="submit">Filtrar</button>
		</form>


<!-- Tabla de operaciones -->
<div th:if="${operaciones != null and not #lists.isEmpty(operaciones)}">
    <table>
        <thead>
            <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Cliente</th>
                <th>Monto Origen</th>
                <th>TC</th>
                <th>Monto Conversión</th>
                <th>Referido</th>
                <th>Estado</th>
                <th>Acciones</th>                       
            </tr>
        </thead>
        <tbody>
            <tr th:each="operacion, opStat : ${operaciones}">
                <td th:text="${#temporals.format(operacion.fecha, 'dd-MM-yyyy HH:mm')}"></td>
                <td th:text="${operacion.tipo}"></td>
                <td th:text="${operacion.nombreCliente}"></td>
                <td>
                    <div th:text="${#numbers.formatDecimal(operacion.montoOrigen, 1, 2, 'COMMA')}"></div>
                    <button type="button" class="btn-ver-pagos" th:onclick="'togglePagos(\'pagosOrigen_' + ${opStat.index} + '\')'">
                        Ver pagos origen
                    </button>
                    <div th:id="'pagosOrigen_' + ${opStat.index}" class="pagos-detalle" style="display: none;">
                        <table class="pagos-tabla">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo Entrega</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="pago : ${operacion.pagosOrigen}">
                                    <td th:text="${#temporals.format(pago.fecha, 'dd-MM-yyyy HH:mm')}"></td>
                                    <td th:text="${pago.tipoEntrega}"></td>
                                    <td th:text="${#numbers.formatDecimal(pago.valor, 1, 2, 'COMMA')}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </td>
                <td th:text="${operacion.valorTipoCambio}"></td>
                <td>
                    <div th:text="${#numbers.formatDecimal(operacion.montoConversion, 1, 2, 'COMMA')}"></div>
                    <button type="button" class="btn-ver-pagos" th:onclick="'togglePagos(\'pagosConversion_' + ${opStat.index} + '\')'">
                        Ver pagos conversión
                    </button>
                    <div th:id="'pagosConversion_' + ${opStat.index}" class="pagos-detalle" style="display: none;">
                        <table class="pagos-tabla">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo Entrega</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="pago : ${operacion.pagosConversion}">
                                    <td th:text="${#temporals.format(pago.fecha, 'dd-MM-yyyy HH:mm')}"></td>
                                    <td th:text="${pago.tipoEntrega}"></td>
                                    <td th:text="${#numbers.formatDecimal(pago.valor, 1, 2, 'COMMA')}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </td>
                <td th:text="${operacion.nombreReferido}"></td>
                <td th:text="${operacion.estado}"></td>
                <td>
                    <!-- Botón de Editar con ícono -->
                    <button th:attr="onclick=|mostrarModalOperacion('editar', '${operacion.id}', '${operacion.tipo}', 
                                '${operacion.nombreCliente}', '${operacion.monedaOrigen}', '${operacion.montoOrigen}', 
                                '${operacion.monedaConversion}', '${operacion.valorTipoCambio}', 
                                '${operacion.nombreReferido}', '${operacion.puntosReferido}', '${operacion.gananciaReferido}', 
                                '${operacion.monedaReferido}')|">
                        <i class="fas fa-edit"></i>
                    </button>

                    <!-- Botón de Eliminar con ícono -->
                    <button th:attr="onclick=|confirmarEliminacionOperacion('${operacion.id}')|">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>
        </tbody>
    </table>
</div>	       
		           

		   <!-- Paginación -->
		   <div th:if="${operaciones.totalPages > 1}">
		       <span th:if="${!operaciones.first}">
		           <a th:href="@{/operaciones(page=0, size=${operaciones.size}, 
		                   fechaInicio=${fechaInicio}, fechaFin=${fechaFin}, 
		                   montoOrigen=${montoOrigen}, monedaOrigen=${monedaOrigen}, 
		                   montoConversion=${montoConversion}, monedaConversion=${monedaConversion}, 
		                   tipo=${tipo}, clienteNombre=${clienteNombre})}">Primera</a>
		       </span>
		       
		       <span th:if="${operaciones.hasPrevious()}">
		           <a th:href="@{/operaciones(page=${operaciones.number - 1}, size=${operaciones.size}, 
		                   fechaInicio=${fechaInicio}, fechaFin=${fechaFin}, 
		                   montoOrigen=${montoOrigen}, monedaOrigen=${monedaOrigen}, 
		                   montoConversion=${montoConversion}, monedaConversion=${monedaConversion}, 
		                   tipo=${tipo}, clienteNombre=${clienteNombre})}">Anterior</a>
		       </span>

		       <span th:each="i : ${#numbers.sequence(1, operaciones.totalPages)}">
		           <a th:if="${i - 1 != operaciones.number}" 
		              th:href="@{/operaciones(page=${i - 1}, size=${operaciones.size}, 
		                   fechaInicio=${fechaInicio}, fechaFin=${fechaFin}, 
		                   montoOrigen=${montoOrigen}, monedaOrigen=${monedaOrigen}, 
		                   montoConversion=${montoConversion}, monedaConversion=${monedaConversion}, 
		                   tipo=${tipo}, clienteNombre=${clienteNombre})}" 
		              th:text="${i}">1</a>
		           <span th:unless="${i - 1 != operaciones.number}" th:text="${i}">1</span>
		       </span>

		       <span th:if="${operaciones.hasNext()}">
		           <a th:href="@{/operaciones(page=${operaciones.number + 1}, size=${operaciones.size}, 
		                   fechaInicio=${fechaInicio}, fechaFin=${fechaFin}, 
		                   montoOrigen=${montoOrigen}, monedaOrigen=${monedaOrigen}, 
		                   montoConversion=${montoConversion}, monedaConversion=${monedaConversion}, 
		                   tipo=${tipo}, clienteNombre=${clienteNombre})}">Siguiente</a>
		       </span>

		       <span th:if="${!operaciones.last}">
		           <a th:href="@{/operaciones(page=${operaciones.totalPages - 1}, size=${operaciones.size}, 
		                   fechaInicio=${fechaInicio}, fechaFin=${fechaFin}, 
		                   montoOrigen=${montoOrigen}, monedaOrigen=${monedaOrigen}, 
		                   montoConversion=${montoConversion}, monedaConversion=${monedaConversion}, 
		                   tipo=${tipo}, clienteNombre=${clienteNombre})}">Última</a>
		       </span>
		   </div>

		   <!-- Información de la paginación -->
		   <div>
		       <p>Página <span th:text="${operaciones.number + 1}">1</span> de <span th:text="${operaciones.totalPages}">1</span></p>
		       <p>Total de operaciones: <span th:text="${operaciones.totalElements}">0</span></p>
		   </div>
<script>


</script>

</body>	

<style>

</style>

</html>
