<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Operaciones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
	<style>
	    #filtroForm {
	        display: flex;
	        gap: 10px;
	        align-items: center;
	        flex-wrap: wrap;
	    }
	    #filtroForm input, #filtroForm select, #filtroForm button {
	        padding: 5px;
	        font-size: 14px;
	    }
	</style>	
</head>
<body>
    <!-- Sidebar -->
    <div id="sidebar">
        <a href="javascript:void(0)" class="close-btn" onclick="toggleSidebar()">&times;</a>
        <a href="/referidos">Referidos</a>
        <a href="/clientes">Clientes</a>
    </div>
    <div class="open-btn" onclick="toggleSidebar()">&#9776;</div>

    <div id="main">
        <h1>Operaciones</h1>
        
        <!-- Botón para abrir el modal de nueva operación -->
        <button onclick="mostrarModal('crear')">Nueva Operación</button>
        
		    <!-- Modal para crear operación -->
		    <div id="modal-overlay">
		        <div id="modal-content">
		            <button id="modal-close-btn" onclick="ocultarModal()">&times;</button>
		            <form id="operacionForm" method="post" onsubmit="return procesarFormulario()">
		                <label>Cliente:</label>
		                <input type="text" id="nombreCliente" name="nombreCliente" required>

		                <label>Tipo de Operación:</label>
		                <select id="tipo" name="tipo" required>
		                    <option value="COMPRA">Compra</option>
		                    <option value="VENTA">Venta</option>
		                </select>

		                <label>Moneda Origen:</label>
		                <select id="monedaOrigen" name="monedaOrigen" required>
		                    <option value="USD">USD</option>
		                    <option value="EUR">EUR</option>
		                    <option value="BRL">BRL</option>
		                    <option value="ARS">ARS</option>
		                </select>

		                <label>Monto Origen:</label>
		                <input type="number" id="montoOrigen" name="montoOrigen" step="0.01" required>

		                <label>Moneda Conversión:</label>
		                <select id="monedaConversion" name="monedaConversion" required>
		                    <option value="USD">USD</option>
		                    <option value="EUR">EUR</option>
		                    <option value="BRL">BRL</option>
		                    <option value="ARS">ARS</option>
		                </select>
		                
		                <!-- Checkbox para activar referido -->
		                <label>
		                    <input type="checkbox" id="tieneReferido" onchange="toggleReferido()"> Incluir Referido
		                </label>

		                <div id="referidoFields" style="display: none;">
		                    <label>Referido:</label>
		                    <input type="text" id="nombreReferido" name="nombreReferido">

		                    <label>Puntos Referido:</label>
		                    <input type="number" id="puntosReferido" name="puntosReferido" step="0.01">

		                    <label>Ganancia Referido:</label>
		                    <input type="number" id="gananciaReferido" name="gananciaReferido" step="0.01">

		                    <label>Moneda Ganancia Referido:</label>
		                    <select id="monedaReferido" name="monedaReferido">
		                        <option value="USD">USD</option>
		                        <option value="EUR">EUR</option>
		                        <option value="BRL">BRL</option>
		                        <option value="ARS">ARS</option>
		                    </select>
		                </div>
		                
		                <button type="submit">Guardar</button>
		                <button type="button" onclick="ocultarModal()">Cancelar</button>
		            </form>
		        </div>
		    </div>
		</div>
        
		<!-- Filtros en formato grid -->
		<form id="filtroForm">
		    <input type="date" name="fechaInicio" placeholder="Fecha Inicio">
		    <input type="date" name="fechaFin" placeholder="Fecha Fin">
		    <input type="text" name="monto" placeholder="Monto" oninput="formatearNumero(this)">
		    <select name="moneda">
		        <option value="">Moneda</option>
		        <option value="USD">USD</option>
		        <option value="EUR">EUR</option>
		        <option value="BRL">BRL</option>
		        <option value="ARS">ARS</option>
		    </select>
		    <select name="tipo">
		        <option value="">Tipo</option>
		        <option value="COMPRA">Compra</option>
		        <option value="VENTA">Venta</option>
		    </select>
		    <input type="text" name="cliente" placeholder="Cliente">
		    <button type="submit">Filtrar</button>
		</form>
		  
		  

		       <!-- Tabla de operaciones -->
		       <div th:if="${operaciones != null and not #lists.isEmpty(operaciones)}">
		           <table>
		               <thead>
		                   <tr>
		                       <th>Fecha</th>
		                       <th>Tipo</th>
		                       <th>Cliente</th>
		                       <th>Referencia</th>
		                       <th>Monto Origen</th>
		                       <th>Monto Conversión</th>
		                       <th>Acciones</th>
		                   </tr>
		               </thead>
		               <tbody>
		                   <tr th:each="operacion : ${operaciones}">
		                       <td th:text="${operacion.fecha}"></td>
		                       <td th:text="${operacion.tipo}"></td>
		                       <td th:text="${operacion.nombreCliente}"></td>
		                       <td th:text="${operacion.nombreReferido}"></td>
		                       <td th:text="${#numbers.formatDecimal(operacion.montoOrigen, 1, 2, 'COMMA')}"></td>
		                       <td th:text="${#numbers.formatDecimal(operacion.montoConversion, 1, 2, 'COMMA')}"></td>
		                       <td>
		                           <button><i class="fas fa-edit"></i></button>
		                           <button><i class="fas fa-trash-alt"></i></button>
		                       </td>
		                   </tr>
		               </tbody>
		           </table>
		       </div>
		   </div>        

    <script>
		function toggleSidebar() {
		    const sidebar = document.getElementById("sidebar");
		    sidebar.style.left = sidebar.style.left === "0px" ? "-250px" : "0px";
		}

		function mostrarModal() {
		    document.getElementById("modal-overlay").style.display = "block";
		}

		function ocultarModal() {
		    document.getElementById("modal-overlay").style.display = "none";
		}

		function toggleReferido() {
		    const checkbox = document.getElementById("tieneReferido");
		    const referidoFields = document.getElementById("referidoFields");
		    if (checkbox.checked) {
		        referidoFields.style.display = "block";
		    } else {
		        referidoFields.style.display = "none";
		        document.getElementById("nombreReferido").value = "";
		        document.getElementById("puntosReferido").value = "";
		        document.getElementById("gananciaReferido").value = "";
		        document.getElementById("monedaReferido").value = "";
		    }
		}

		function procesarFormulario() {
		    const checkbox = document.getElementById("tieneReferido");
		    if (!checkbox.checked) {
		        document.getElementById("nombreReferido").removeAttribute("name");
		        document.getElementById("puntosReferido").removeAttribute("name");
		        document.getElementById("gananciaReferido").removeAttribute("name");
		        document.getElementById("monedaReferido").removeAttribute("name");
		    }
		    return true;
		}
		
		function formatearNumero(input) {
		    let value = input.value.replace(/,/g, '');
		    if (!isNaN(value) && value !== "") {
		        input.value = parseFloat(value).toLocaleString('en-US', {
		            minimumFractionDigits: 2,
		            maximumFractionDigits: 2
		        });
		    }
		}
    </script>
</body>
</html>
